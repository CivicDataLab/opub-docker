version: '3'

# volumes:
#   mysql_data:
#       driver: local

services:
  mysql:
      image: mysql:latest
      container_name: opub-db-mysql
      # volumes:
      #   - ./mysql-config:/docker-entrypoint-initdb.d
      environment:
        MYSQL_ROOT_PASSWORD: root
        # MYSQL_DATABASE: keycloak
        # MYSQL_USER: keycloak
        # MYSQL_PASSWORD: password
  
  keycloak:
      image: quay.io/keycloak/keycloak:legacy
      container_name: opub-auth-kc
      # volumes:
      # - ./imports:/opt/jboss/keycloak/imports
      # command: 
      # - "-b 0.0.0.0 -D keycloak.import=/opt/jboss/keycloak/imports/realm-export.json"
      environment:
        DB_VENDOR: MYSQL
        DB_ADDR: mysql
        DB_DATABASE: keycloak
        DB_USER: root
        DB_PASSWORD: root
        KEYCLOAK_USER: admin
        KEYCLOAK_PASSWORD: Pa55w0rd
        # Uncomment the line below if you want to specify JDBC parameters. The parameter below is just an example, and it shouldn't be used in production without knowledge. It is highly recommended that you read the MySQL JDBC driver documentation in order to use it.
        #JDBC_PARAMS: "connectTimeout=30000"
      ports:
        - 8080:8080
      depends_on:
        - mysql
  
  postgres:
    image: postgres
    environment:
      POSTGRES_DB: strapi
      POSTGRES_USER: strapi
      POSTGRES_PASSWORD: strapi
    # volumes:
    #   - ./data:/var/lib/postgresql/data

  strapi:
    image: strapi/strapi:latest
    environment:
      DATABASE_CLIENT: postgres
      DATABASE_NAME: strapi
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_USERNAME: strapi
      DATABASE_PASSWORD: strapi
    volumes:
      - ./app:/srv/app
    ports:
      - '1337:1337'
    depends_on:
      - postgres
      
  next_app:
      image: node:alpine
      container_name: opub-next-js-app
      build:
        # Refering to docker branch of the OPUB repo
        context: https://github.com/CivicDataLab/opub.git#docker
        # dockerfile: Dockerfile
      ports:
        - 3000:3000
  